---
title: "Rust and Cloudflare Workers"
emoji: "ğŸ¦"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: []
published: false
---
Rust ã§ REST API ã‚’å®Ÿè£…ã™ã‚‹æ–¹æ³•ã‚’èª¿ã¹ã‚‹ã€‚

æ¥­å‹™ã§ã®å®Ÿè·µã«è¿‘ã„å½¢ã«ã™ã‚‹ãŸã‚ã€Stateful ã«å®Ÿè£…ã™ã‚‹ã€‚

ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã¯ã€ç„¡èª²é‡‘ã§ã‚„ã‚ŠãŸã„ã®ã§ã€D1 ã‚’ä½¿ã†ã€‚Rust + Workers + D1ã€‚

Rust ã® syntax ã«æ…£ã‚Œã¦ã„ãªã„ãŸã‚ã€Application ã§ã®åˆ©ç”¨ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç¹°ã‚Šè¿”ã—å®Ÿè£…ã—ã¦æ…£ã‚Œã‚‹ã€‚

ä»Šå›ã®ã‚³ãƒ¼ãƒ‰ã¯ã“ã¡ã‚‰ã€‚

https://github.com/danny-yamamoto/rust-worker

## environment
Cloudflare ã® template ã‚’ä½¿ç”¨ã™ã‚‹ã€‚

https://developers.cloudflare.com/workers/runtime-apis/webassembly/rust/

## Stateful
D1 ã‚’æº–å‚™ã™ã‚‹ã€‚
wrangler ã§ local ã« D1 ã®ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™ã™ã‚‹ã€‚

```bash
wrangler d1 execute test-db \
  --local --command "CREATE TABLE IF NOT EXISTS users ( user_id INTEGER PRIMARY KEY, email_address TEXT, created_at INTEGER, deleted INTEGER, settings TEXT);"

npx wrangler d1 execute test-db \
  --local --command "INSERT INTO users (user_id, email_address, created_at, deleted, settings) VALUES (1, 'maria@example.com', 0, 0, '');"
npx wrangler d1 execute test-db \
  --local --command "INSERT INTO users (user_id, email_address, created_at, deleted, settings) VALUES (999, 'admin@example.com', 0, 0, '');"

npx wrangler d1 execute test-db \
  --local --command "select * from users;"
```

## REST API
* å®Ÿè£…ä»•æ§˜
`/`: å…¨ä»¶å–å¾—
`/n`: `user_id` ã‚’æŒ‡å®šã™ã‚‹ã€‚

```rust
    Router::new()
    .get_async("/:id", |_, ctx| async move {
        let id = match ctx.param("id") {
            Some(value) => value,
            None => {
                eprintln!("Error: id parameter not found");
                "default_id"
            }
        };
        let d1 = ctx.env.d1("DB")?;
        let statement = d1.prepare("select * from users where user_id = ?1");
        let query = statement.bind(&[id.into()])?;
        let res = query.first::<Users>(None).await;
        match res {
            Ok(Some(user)) => {
                let json = serde_json::to_string(&user)
                    .map_err(|e| Error::from(e.to_string()))?;
                Response::ok(json)
            },
            Ok(None) => Response::error("Not Found", 404),
            Err(e) => {
                eprintln!("Database error: {:?}", e);
                Response::error("Internal Server Error", 500)
            },
        }
    })
    .get_async("/", |_, ctx| async move {
        let d1 = ctx.env.d1("DB")?;
        let statement = d1.prepare("select * from users");
        let res = statement.all().await?;
        Response::from_json(&res.results::<Users>().unwrap())
    }).run(request, env).await
```

```bash
vscode âœ /workspaces/rust-worker (main) $ curl localhost:8787
[{"user_id":1,"email_address":"maria@example.com","created_at":0,"deleted":0,"settings":""},{"user_id":999,"email_address":"admin@example.com","created_at":0,"deleted":0,"settings":"
vscode âœ /workspaces/rust-worker (main) $ curl localhost:8787/1
{"user_id":1,"email_address":"maria@example.com","created_at":0,"deleted":0,"settings":""}
vscode âœ /workspaces/rust-worker (main) $ 
```

## Impression
- Rust ã®æ›¸ãæ–¹ã§å¥½æ„Ÿã‚’è¦šãˆã‚‹ã®ã¯ã€`match`ã€‚
`if` ã§åˆ†å²ã•ã›ã‚‹å¿…è¦ã¯ãªã„ã—ã€ç°¡æ½”ã«æ›¸ãã“ã¨ãŒå¯èƒ½ã€‚
- ã¾ã ã€ç›´æ„Ÿçš„ã«æ›¸ã‘ã‚‹ã¨ã“ã‚ã¾ã§æ¥ã¦ã„ãªã„ã€‚ä¾‹ãˆã°ã€namespace ã®è§£æ±ºã‚„é–¢é€£é–¢æ•°ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã«ç”¨ã„ã‚‹ `::` ã«ã¤ã„ã¦ã€è¿·ã†ã€‚

## GPT-4 ã‚³ãƒ¼ãƒ‰è§£èª¬
> ã“ã®Rustã®ã‚³ãƒ¼ãƒ‰ã¯ã€WebAssemblyã®ãŸã‚ã«æ›¸ã‹ã‚ŒãŸHTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¯¾å¿œã™ã‚‹ã‚µãƒ¼ãƒãƒ¬ã‚¹é–¢æ•°ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ•ãƒ¬ã‚¢ã®Workersï¼ˆã‚ã‚‹ã„ã¯åŒæ§˜ã®ã‚µãƒ¼ãƒãƒ¬ã‚¹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ï¼‰ã§å‹•ä½œã™ã‚‹ã“ã¨ã‚’æ„å›³ã—ã¦ã„ã‚‹ã¨æ€ã‚ã‚Œã¾ã™ã€‚ã“ã®ã‚³ãƒ¼ãƒ‰ã¯ã€ç‰¹å®šã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¸ã®HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†ã—ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆãŠãã‚‰ãCloudflare Workersã®D1ï¼‰ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—ã—ã¦ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã—ã¾ã™ã€‚å…·ä½“çš„ãªéƒ¨åˆ†ã‚’èª¬æ˜ã—ã¾ã™ã€‚
> 1. **ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¨ã‚¯ãƒ¬ãƒ¼ãƒˆã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ**:
    `worker`ã‚¯ãƒ¬ãƒ¼ãƒˆã¨`serde`ã‚¯ãƒ¬ãƒ¼ãƒˆã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ã€‚`worker`ã¯WebAssemblyãƒ™ãƒ¼ã‚¹ã®ã‚µãƒ¼ãƒãƒ¬ã‚¹ç’°å¢ƒç”¨ã®APIã‚’æä¾›ã—ã€`serde`ã¯Rustã§ã®ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºï¼ˆãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’JSONãªã©ã®å½¢å¼ã«å¤‰æ›ï¼‰ãŠã‚ˆã³ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºï¼ˆãã®é€†ã®æ“ä½œï¼‰ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚
> 1. **`Users`æ§‹é€ ä½“ã®å®šç¾©**:
    `Users`æ§‹é€ ä½“ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¡¨ã™ãŸã‚ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã§ã™ã€‚`Deserialize`ã¨`Serialize`ãƒˆãƒ¬ã‚¤ãƒˆãŒå°å‡ºã•ã‚Œã¦ãŠã‚Šã€ã“ã‚Œã«ã‚ˆã‚ŠJSONå½¢å¼ã¨ã®å¤‰æ›ãŒå¯èƒ½ã«ãªã£ã¦ã„ã¾ã™ã€‚`serde(rename = "name")`ã‚¢ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ãƒˆã¯ã€JSONã‚­ãƒ¼åã¨Rustãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã‚’å¯¾å¿œã•ã›ã¦ã„ã¾ã™ã€‚
> 1. **`main`é–¢æ•°ï¼ˆéåŒæœŸï¼‰**:
    `main`é–¢æ•°ã¯éåŒæœŸã§ã‚ã‚Šã€HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘å–ã£ã¦å‡¦ç†ã—ã¾ã™ã€‚ã“ã®é–¢æ•°ã¯`Result<Response>`ã‚’è¿”ã—ã¾ã™ã€‚
> 1. **ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°**:
    HTTPã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã”ã¨ã«ç•°ãªã‚‹ãƒãƒ³ãƒ‰ãƒ©é–¢æ•°ã‚’å®šç¾©ã—ã¦ã„ã¾ã™ã€‚
    - `GET /:id`: æŒ‡å®šã•ã‚ŒãŸIDã«å¯¾å¿œã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰æ¤œç´¢ã—ã¦è¿”ã—ã¾ã™ã€‚
    - `GET /`: ã™ã¹ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰å–å¾—ã—ã¦è¿”ã—ã¾ã™ã€‚
> 1. **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å‡¦ç†**:
    SQLã‚¯ã‚¨ãƒªã‚’ä½¿ã£ã¦ã€D1ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆCloudflareã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ã„ã¾ã™ã€‚
> 1. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**:
    ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ã‚¨ãƒªã‚„ãƒ‡ãƒ¼ã‚¿å–å¾—ã®éš›ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã€é©åˆ‡ãªHTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ï¼ˆ404ã‚„500ãªã©ï¼‰ã¨ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¨ã—ã¦è¿”ã—ã¾ã™ã€‚
>
> ã“ã®ã‚³ãƒ¼ãƒ‰ã¯ã€Rustã§ã‚¯ãƒ©ã‚¦ãƒ‰ãƒã‚¤ãƒ†ã‚£ãƒ–ã®Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹ç™ºã™ã‚‹éš›ã®ä¸€ä¾‹ã‚’ç¤ºã—ã¦ãŠã‚Šã€WebAssemblyã¨Rustã®çµ„ã¿åˆã‚ã›ã«ã‚ˆã‚‹é«˜æ€§èƒ½ã‹ã¤ã‚»ã‚­ãƒ¥ã‚¢ãªã‚µãƒ¼ãƒãƒ¬ã‚¹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹ç™ºã‚’å®Ÿç¾ã—ã¦ã„ã¾ã™ã€‚