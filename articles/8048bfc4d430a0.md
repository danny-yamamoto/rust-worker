---
title: "Rust and Cloudflare Workers"
emoji: "ğŸ¦"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: []
published: false
---
Rust ã§ REST API ã‚’å®Ÿè£…ã™ã‚‹æ–¹æ³•ã‚’èª¿ã¹ã‚‹ã€‚

æ¥­å‹™ã§ã®å®Ÿè·µã«è¿‘ã„å½¢ã«ã™ã‚‹ãŸã‚ã€Stateful ã«å®Ÿè£…ã™ã‚‹ã€‚

ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã¯ã€ç„¡èª²é‡‘ã§ã‚„ã‚ŠãŸã„ã®ã§ã€D1 ã‚’ä½¿ã†ã€‚Rust + Workers + D1ã€‚

Rust ã® syntax ã«æ…£ã‚Œã¦ã„ãªã„ãŸã‚ã€Application ã§ã®åˆ©ç”¨ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç¹°ã‚Šè¿”ã—å®Ÿè£…ã—ã¦æ…£ã‚Œã‚‹ã€‚

ä»Šå›ã®ã‚³ãƒ¼ãƒ‰ã¯ã“ã¡ã‚‰ã€‚

https://github.com/danny-yamamoto/rust-worker

## environment
Cloudflare ã® template ã‚’ä½¿ç”¨ã™ã‚‹ã€‚

https://developers.cloudflare.com/workers/runtime-apis/webassembly/rust/

## Stateful
D1 ã‚’æº–å‚™ã™ã‚‹ã€‚
wrangler ã§ local ã« D1 ã®ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™ã™ã‚‹ã€‚

```bash
wrangler d1 execute test-db \
  --local --command "CREATE TABLE IF NOT EXISTS users ( user_id INTEGER PRIMARY KEY, email_address TEXT, created_at INTEGER, deleted INTEGER, settings TEXT);"

npx wrangler d1 execute test-db \
  --local --command "INSERT INTO users (user_id, email_address, created_at, deleted, settings) VALUES (1, 'maria@example.com', 0, 0, '');"
npx wrangler d1 execute test-db \
  --local --command "INSERT INTO users (user_id, email_address, created_at, deleted, settings) VALUES (999, 'admin@example.com', 0, 0, '');"

npx wrangler d1 execute test-db \
  --local --command "select * from users;"
```

## REST API
* å®Ÿè£…ä»•æ§˜
`/`: å…¨ä»¶å–å¾—
`/n`: `user_id` ã‚’æŒ‡å®šã™ã‚‹ã€‚

```rust
    Router::new()
    .get_async("/:id", |_, ctx| async move {
        let id = match ctx.param("id") {
            Some(value) => value,
            None => {
                eprintln!("Error: id parameter not found");
                "default_id"
            }
        };
        let d1 = ctx.env.d1("DB")?;
        let statement = d1.prepare("select * from users where user_id = ?1");
        let query = statement.bind(&[id.into()])?;
        let res = query.first::<Users>(None).await;
        match res {
            Ok(Some(user)) => {
                let json = serde_json::to_string(&user)
                    .map_err(|e| Error::from(e.to_string()))?;
                Response::ok(json)
            },
            Ok(None) => Response::error("Not Found", 404),
            Err(e) => {
                eprintln!("Database error: {:?}", e);
                Response::error("Internal Server Error", 500)
            },
        }
    })
    .get_async("/", |_, ctx| async move {
        let d1 = ctx.env.d1("DB")?;
        let statement = d1.prepare("select * from users");
        let res = statement.all().await?;
        Response::from_json(&res.results::<Users>().unwrap())
    }).run(request, env).await
```

```bash
vscode âœ /workspaces/rust-worker (main) $ curl localhost:8787
[{"user_id":1,"email_address":"maria@example.com","created_at":0,"deleted":0,"settings":""},{"user_id":999,"email_address":"admin@example.com","created_at":0,"deleted":0,"settings":"
vscode âœ /workspaces/rust-worker (main) $ curl localhost:8787/1
{"user_id":1,"email_address":"maria@example.com","created_at":0,"deleted":0,"settings":""}
vscode âœ /workspaces/rust-worker (main) $ 
```

## Impression
- Rust ã®æ›¸ãæ–¹ã§å¥½æ„Ÿã‚’è¦šãˆã‚‹ã®ã¯ã€`match`ã€‚
`if` ã§åˆ†å²ã•ã›ã‚‹å¿…è¦ã¯ãªã„ã—ã€ç°¡æ½”ã«æ›¸ãã“ã¨ãŒå¯èƒ½ã€‚
- ã¾ã ã€ç›´æ„Ÿçš„ã«æ›¸ã‘ã‚‹ã¨ã“ã‚ã¾ã§æ¥ã¦ã„ãªã„ã€‚ä¾‹ãˆã°ã€namespace ã®è§£æ±ºã‚„é–¢é€£é–¢æ•°ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã«ç”¨ã„ã‚‹ `::` ã«ã¤ã„ã¦ã€è¿·ã†ã€‚
